
# Before running:
# . $HOME/esp/esp-idf/export.sh

# pip install esptool

CHIP=esp32
BAUD=921600
IDF=idf.py
ESPTOOL=esptool.py

GIT_SUBMODULES=components/lvgl \
	components/lvgl_esp32_drivers \
	components/lv_demos/lv_demos

CLEAN_ITEMS=build \
	sdkconfig \
	sdkconfig.old \
	pcb/CapTouchStarter.sch-bak \
	pcb/CapTouchStarter.kicad_pcb-bak \
	pcb/CapTouchStarter-cache.lib \
	pcb/fp-info-cache

.PHONY: format
format:
	clang-format -i main/*.cc main/*.c main/*.h

.PHONY: clean
clean:
	python scripts/delete-items.py ${CLEAN_ITEMS}

.PHONY: config
config:
	${IDF} menuconfig

.PHONY: target
target:
	${IDF} set-target ${CHIP}

.PHONY: build
build:
	${IDF} build

.PHONY: openocd
openocd:
	idf.py openocd

.PHONY: debug
debug:
	idf.py gdbtui

build/bootloader/bootloader.bin:
	${IDF} build

.PHONY: flash
flash:
	${IDF} --port ${FLASH_PORT} --baud ${BAUD} flash

.PHONY: app-flash
app-flash:
	${IDF} --port ${FLASH_PORT} --baud ${BAUD} app-flash

.PHONY: monitor
monitor:
	${IDF} --port ${MONITOR_PORT} monitor

# Manual flash should be the equivalent of the flash target above.
.PHONY: manual-flash
manual-flash: build/bootloader/bootloader.bin
	esptool.py --chip ${CHIP} --port ${FLASH_PORT} --baud ${BAUD} \
		--before=default_reset --after=no_reset write_flash \
		--flash_mode dio --flash_size detect --flash_freq 80m \
		0x1000 build/bootloader/bootloader.bin \
		0x8000 build/partition_table/partition-table.bin \
		0x10000 build/keyboard.bin \
		0x210000 build/storage.bin; \
		echo "Press the RST button."

.PHONY: flash-erase
flash-erase:
	${ESPTOOL} --chip ${CHIP} --port ${FLASH_PORT} --baud ${BAUD} erase_flash

.PHONY: submodules
submodules:
	git submodule update --init ${GIT_SUBMODULES}
